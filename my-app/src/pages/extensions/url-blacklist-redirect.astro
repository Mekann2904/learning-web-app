---
import Base from "../../layouts/Base.astro";
import CopyCodeButton from "../../components/CopyCodeButton";
import scriptSource from "../../data/extensions/url-blacklist-redirect.user.js?raw";

const violentMonkeyUrl = "https://violentmonkey.github.io";
---
<Base title="URL Blacklist Redirect">
  <section class="space-y-8">
    <div class="rounded-2xl border border-border bg-card p-6 shadow-sm">
      <div class="flex flex-col gap-4">
        <div>
          <span class="inline-flex items-center rounded-full bg-muted px-3 py-1 text-xs font-medium text-muted-foreground">
            Userscript
          </span>
          <h1 class="mt-3 text-2xl font-semibold text-foreground">URL Blacklist Redirect</h1>
          <p class="text-sm text-muted-foreground">
            指定した URL／ドメインにアクセスした際に、短い猫の手アニメーションを表示してから任意のリンク先へリダイレクトするユーザースクリプトです。公式アプリの導入案内から配布する想定で整理されたドキュメントを掲載しています。
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <CopyCodeButton client:load code={scriptSource} label="コードをコピー" />
          <p class="text-muted-foreground">
            Userscript マネージャ（例: <a class="text-primary underline" href={violentMonkeyUrl} target="_blank" rel="noreferrer">Violentmonkey</a>）を用意してから貼り付けてください。
          </p>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold text-foreground">スクリプト本体</h2>
      <p class="text-sm text-muted-foreground">
        下記コードをコピーして Userscript マネージャに追加してください。必要に応じてブラックリストやリダイレクト先を編集できます。
      </p>
      <div class="relative overflow-hidden rounded-2xl border border-border bg-card">
        <pre class="max-h-[420px] overflow-auto p-4 text-sm leading-relaxed text-muted-foreground">
{scriptSource}
        </pre>
      </div>
    </div>

    <article class="space-y-8 rounded-2xl border border-border bg-card p-6 shadow-sm">
      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">概要</h2>
        <p class="text-sm text-muted-foreground">
          このスクリプトは、ユーザが管理するブラックリストに一致した URL へアクセスすると猫の手アニメーションを表示した後、指定したリダイレクト先に遷移させます。ブラウザの Userscript マネージャ（Chromium 系／Firefox 系など）経由で導入し、公式アプリ側の「導入ボタン」から配布することを想定しています。
        </p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">主な機能</h2>
        <div class="overflow-hidden rounded-xl border border-border">
          <table class="w-full text-sm">
            <thead class="bg-muted/60 text-left text-xs uppercase text-muted-foreground">
              <tr>
                <th class="px-4 py-2 font-medium">項目</th>
                <th class="px-4 py-2 font-medium">説明</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border bg-card">
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">ブラックリスト</td>
                <td class="px-4 py-3 text-muted-foreground">ユーザが設定可能。部分一致で判定する文字列一覧を保存。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">リダイレクト先</td>
                <td class="px-4 py-3 text-muted-foreground">ブラックリストにマッチした場合に遷移する先をユーザが指定。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">アニメーション</td>
                <td class="px-4 py-3 text-muted-foreground">画面右下から猫の手がスライドインして短時間表示（演出用）。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">保存方式</td>
                <td class="px-4 py-3 text-muted-foreground">Userscript のストレージ（GM.getValue / GM.setValue）を利用。外部送信なし。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">メニュー</td>
                <td class="px-4 py-3 text-muted-foreground">現在のドメイン追加・ブラックリスト編集・リダイレクト先変更などをメニューから実行。</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-foreground">インストール手順（利用者向け）</h2>
        <ol class="space-y-3 text-sm text-muted-foreground">
          <li>対応ブラウザで Userscript 管理拡張をインストールします。<a class="text-primary underline" href={violentMonkeyUrl} target="_blank" rel="noreferrer">Violentmonkey</a> などが利用できます。</li>
          <li>本ページの「インストール」ボタンをクリック、またはスクリプトの raw URL を Userscript マネージャに読み込ませます。</li>
          <li>スクリプトを有効化し、目的のページを再読み込みすると動作します。初期設定ではデフォルトのブラックリストとリダイレクト先が適用されます。</li>
          <li>必要に応じて拡張メニューから「現在のドメインをブロック」「ブラックリストを編集」等を実行して挙動を調整してください。</li>
        </ol>
        <p class="text-xs text-muted-foreground">
          インストールはすべて利用者の明示的な操作に依存します。導入時は注意事項とリスクを事前に案内してください。
        </p>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-foreground">配布方法（運営向け）</h2>
        <ol class="space-y-3 text-sm text-muted-foreground">
          <li>スクリプトファイルを Git 等でバージョン管理し、リリースごとにタグ付けします。利用者には raw URL を提供すると導入が容易です。</li>
          <li>サイトに「Install」ボタンを設置する場合はリンク先をスクリプトの raw URL に設定します。CIDR / CSP 等でブロックされないか事前に確認してください。</li>
          <li>更新時は <code>@version</code> を上げ、Userscript ヘッダに更新チェック用の URL を明記します。</li>
        </ol>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">設定とカスタマイズ</h2>
        <p class="text-sm text-muted-foreground">
          設定は Userscript マネージャのメニューから行えます。ブラックリストは部分一致で判定されるため、ドメイン単位でもパス込みでも柔軟に登録可能です。設定値はローカルに保存され、デフォルトでは外部送信されません。
        </p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">注意事項</h2>
        <ul class="space-y-2 text-sm text-muted-foreground">
          <li>スクリプトは <code>@run-at document-start</code> で動作するため、ページや他拡張との初期化競合が起こる場合があります。</li>
          <li>リダイレクト設定を誤るとユーザが目的のページにアクセスできなくなる可能性があります。導入時はリスクを明示してください。</li>
        </ul>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">セキュリティとプライバシー</h2>
        <p class="text-sm text-muted-foreground">
          スクリプトはローカルストレージのみを使用しますが、配布 URL が改ざんされると悪意のある挙動を注入できます。公式サイトでは配布ファイルの整合性管理を徹底し、可能であればハッシュ値や署名を公開してください。</p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">互換性と制限</h2>
        <p class="text-sm text-muted-foreground">
          Chromium 系／Firefox 系／Safari 系など主要ブラウザでの動作を想定しています。モバイルブラウザはサポート対象外とし、厳格な CSP を設定しているサイトでは一部機能が制限される可能性があります。</p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">トラブルシューティング</h2>
        <p class="text-sm text-muted-foreground">
          リダイレクトが発生しない場合は、Userscript が有効か、ブラックリストの記述が期待どおりかを確認してください。メニューから <code>window.location.hostname</code> をコピーして追加すると検証しやすく、エラーログは開発者ツールのコンソールで確認できます。必要に応じてスクリプトを一時的に無効化してください。</p>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-foreground">よくある質問（FAQ）</h2>
        <div class="space-y-3 text-sm text-muted-foreground">
          <p><strong class="font-medium text-foreground">Q:</strong> データはどこに保存されますか？<br />
            <strong class="font-medium text-foreground">A:</strong> Userscript マネージャの GM.getValue / GM.setValue に保存され、外部送信は行いません。</p>
          <p><strong class="font-medium text-foreground">Q:</strong> ブラックリストの書式は？<br />
            <strong class="font-medium text-foreground">A:</strong> 部分文字列で判定します。必要なら完全一致や正規表現に拡張してください。</p>
          <p><strong class="font-medium text-foreground">Q:</strong> 配布したら自動で全員に入りますか？<br />
            <strong class="font-medium text-foreground">A:</strong> いいえ。ユーザ自身で導入する必要があります。</p>
        </div>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">品質管理チェックリスト</h2>
        <ol class="space-y-2 text-sm text-muted-foreground">
          <li>主要ブラウザでインストール・アニメーション・リダイレクト・メニューを確認する。</li>
          <li>ブラックリストの複数パターン（ドメイン／パス／部分一致）で試験する。</li>
          <li>CSP が厳しいページでの動作を確認する。</li>
          <li>バージョン番号とリリースノート、配布ページのハッシュを用意する。</li>
          <li>第三者への送信機構を組み込まない。必要な場合は利用者の明示的な同意を得る。</li>
        </ol>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">変更履歴（例）</h2>
        <ul class="space-y-2 text-sm text-muted-foreground">
          <li><span class="font-medium text-foreground">2025-09-18 — v3.2.0:</span> 猫の手アニメーション挙動を改善。ブラックリスト保存形式を配列に統一。メニュー項目を追加。</li>
        </ul>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">ライセンスと免責</h2>
        <p class="text-sm text-muted-foreground">
          スクリプトはオープンソース（例: MIT）での配布を推奨します。ただし、導入によって発生した不具合や損害については責任を負わない旨を明示し、導入前に機能とリスクを分かりやすく提示してください。
        </p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">サポート窓口（テンプレ）</h2>
        <p class="text-sm text-muted-foreground">
          問い合わせは公式サポートフォームまたは GitHub Issues で受け付けます。以下の情報を添えてもらうと調査が容易です。
        </p>
        <ul class="space-y-2 text-sm text-muted-foreground">
          <li>利用ブラウザの種類とバージョン</li>
          <li>インストールしたスクリプトのバージョン</li>
          <li>再現手順とスクリーンショット（可能であれば）</li>
        </ul>
      </section>
    </article>

    <p class="text-xs text-muted-foreground">
      配布は容易ですが管理が重要です。導入はユーザ任意とし、ハッシュや配布元の明示など安全対策を徹底してください。
    </p>
  </section>
</Base>
