---
import Base from "../../layouts/Base.astro";
import CopyCodeButton from "../../components/CopyCodeButton";
import UrlBlockApiTester from "../../components/UrlBlockApiTester";
import scriptSource from "../../violentmonkey/url-block.js?raw";

const violentMonkeyUrl = "https://violentmonkey.github.io";
const siteUrl = import.meta.env.PUBLIC_SITE_URL ?? "";
const defaultApiBase = siteUrl ? siteUrl.replace(/\/+$/, "") : "";
---
<Base title="URL Blacklist Redirect">
  <section class="space-y-8">
    <div class="rounded-2xl border border-border bg-card p-6 shadow-sm">
      <div class="flex flex-col gap-4">
        <div>
          <span class="inline-flex items-center rounded-full bg-muted px-3 py-1 text-xs font-medium text-muted-foreground">
            Userscript
          </span>
          <h1 class="mt-3 text-2xl font-semibold text-foreground">URL Blacklist Redirect</h1>
          <p class="text-sm text-muted-foreground">
            指定した URL／ドメインにアクセスした際に、TaskWorks API が返すブロック時間帯に基づいてアクセスを制御し、猫の手アニメーションを表示したのち指定先へリダイレクトする Userscript です。公式アプリ側で配布し、利用者が自分のトークンやブラックリストを設定できるように整えています。
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <CopyCodeButton client:load code={scriptSource} label="コードをコピー" />
          <p class="text-muted-foreground">
            Userscript マネージャ（例: <a class="text-primary underline" href={violentMonkeyUrl} target="_blank" rel="noreferrer">Violentmonkey</a>）を用意してから貼り付けてください。初期状態で <code>https://my-app.yinyoo2904.workers.dev</code> に接続するよう設定済みですが、必要に応じてメニューから TaskWorks API ベース URL やトークン、キャッシュ時間、ブラックリストを変更できます。
          </p>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold text-foreground">スクリプト本体</h2>
      <p class="text-sm text-muted-foreground">
        下記コードをコピーして Userscript マネージャに追加してください。必要に応じてブラックリストやリダイレクト先を編集できます。
      </p>
      <div class="relative overflow-hidden rounded-2xl border border-border bg-card">
        <pre class="max-h-[420px] overflow-auto p-4 text-sm leading-relaxed text-muted-foreground">
{scriptSource}
        </pre>
      </div>
    </div>

    <article class="space-y-8 rounded-2xl border border-border bg-card p-6 shadow-sm">
      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">概要</h2>
        <p class="text-sm text-muted-foreground">
          このスクリプトは、ユーザが管理するブラックリストに一致した URL へアクセスすると猫の手アニメーションを表示した後、指定したリダイレクト先に遷移させます。ブラウザの Userscript マネージャ（Chromium 系／Firefox 系など）経由で導入し、公式アプリ側の「導入ボタン」から配布することを想定しています。
        </p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">主な機能</h2>
        <div class="overflow-hidden rounded-xl border border-border">
          <table class="w-full text-sm">
            <thead class="bg-muted/60 text-left text-xs uppercase text-muted-foreground">
              <tr>
                <th class="px-4 py-2 font-medium">項目</th>
                <th class="px-4 py-2 font-medium">説明</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border bg-card">
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">ブロック時間帯</td>
                <td class="px-4 py-3 text-muted-foreground">TaskWorks API から取得したフォーカスタグ付きタスクをもとに自動生成。API が利用できない場合は手動登録した時間帯を採用します。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">ブラックリスト</td>
                <td class="px-4 py-3 text-muted-foreground">部分一致で判定する文字列を任意に登録。時間帯内のみリダイレクトが有効になります。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">完了済みタスク</td>
                <td class="px-4 py-3 text-muted-foreground">当日の目標回数を満たしたタスクは API 応答から除外され、拡張機能でもブロックされません。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">バックグラウンド更新</td>
                <td class="px-4 py-3 text-muted-foreground">設定したキャッシュ TTL に合わせて背後でウィンドウ情報を再取得し、タスク完了などのイベントでも即時更新されます。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">リダイレクト先</td>
                <td class="px-4 py-3 text-muted-foreground">ブラックリストにマッチした場合に遷移する先をユーザが指定。API のポリシーにリダイレクト先が含まれている場合はそちらを優先します。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">アニメーション</td>
                <td class="px-4 py-3 text-muted-foreground">画面右下に猫の手アニメーションを表示した後、リダイレクトします。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">保存方式</td>
                <td class="px-4 py-3 text-muted-foreground">Userscript ストレージ（GM.getValue / GM.setValue）に API 設定やブラックリスト、キャッシュを保存。外部送信は API 呼び出しのみ。</td>
              </tr>
              <tr>
                <td class="px-4 py-3 font-medium text-foreground">メニュー</td>
                <td class="px-4 py-3 text-muted-foreground">ブラックリスト／リダイレクト先に加え、TaskWorks API ベース URL・トークン・キャッシュ TTL・フォーカスタグのみに絞る設定をメニューから切り替え可能。</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-foreground">インストール手順（利用者向け）</h2>
        <ol class="space-y-3 text-sm text-muted-foreground">
          <li>対応ブラウザで Userscript 管理拡張をインストールします。<a class="text-primary underline" href={violentMonkeyUrl} target="_blank" rel="noreferrer">Violentmonkey</a> などが利用できます。</li>
          <li>本ページの「インストール」ボタンをクリック、またはスクリプトの raw URL を Userscript マネージャに読み込ませます。</li>
          <li>スクリプトを有効化した後、拡張メニューから TaskWorks API ベース URL（例: <code>https://your-app.example</code> または <code>https://your-app.example/api</code> まで）と Bearer トークンを設定します。エンドポイント (<code>/api/v1/blocks/windows</code>) まで含める必要はありません。Cookie 認証を利用する場合はトークン設定を省略できます。</li>
          <li>必要に応じてブラックリスト、手動ブロック時間帯、キャッシュ TTL を編集します。API 取得に失敗した場合は手動設定がフォールバックとして使用されます。</li>
          <li>目的のページを再読み込みすると動作します。タスクのブロック時間帯中のみ、ブラックリストに一致したサイトがリダイレクトされます。</li>
        </ol>
        <p class="text-xs text-muted-foreground">
          インストールはすべて利用者の明示的な操作に依存します。導入時は注意事項とリスクを事前に案内してください。
        </p>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-foreground">配布方法（運営向け）</h2>
        <ol class="space-y-3 text-sm text-muted-foreground">
          <li>スクリプトファイルを Git 等でバージョン管理し、リリースごとにタグ付けします。利用者には raw URL を提供すると導入が容易です。</li>
          <li>サイトに「Install」ボタンを設置する場合はリンク先をスクリプトの raw URL に設定します。CIDR / CSP 等でブロックされないか事前に確認してください。</li>
          <li>更新時は <code>@version</code> を上げ、Userscript ヘッダに更新チェック用の URL を明記します。</li>
        </ol>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">設定とカスタマイズ</h2>
        <p class="text-sm text-muted-foreground">
          設定は Userscript マネージャのメニューから行えます。TaskWorks API を利用する場合はベース URL とトークン、フォーカスタグのみを対象にするかどうか、キャッシュTTL（分）を切り替えられます。ブラックリストや手動時間帯は部分一致で判定でき、すべての設定値はローカルに保存されます。
        </p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">注意事項</h2>
        <ul class="space-y-2 text-sm text-muted-foreground">
          <li>スクリプトは <code>@run-at document-start</code> で動作するため、ページや他拡張との初期化競合が起こる場合があります。</li>
          <li>リダイレクト設定を誤るとユーザが目的のページにアクセスできなくなる可能性があります。導入時はリスクを明示してください。</li>
        </ul>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">セキュリティとプライバシー</h2>
        <p class="text-sm text-muted-foreground">
          スクリプトはローカルストレージのみを使用しますが、配布 URL が改ざんされると悪意のある挙動を注入できます。公式サイトでは配布ファイルの整合性管理を徹底し、可能であればハッシュ値や署名を公開してください。また、API トークンを設定する場合は第三者に共有しないよう利用者へ周知してください。</p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">互換性と制限</h2>
        <p class="text-sm text-muted-foreground">
          Chromium 系／Firefox 系／Safari 系など主要ブラウザでの動作を想定しています。モバイルブラウザはサポート対象外とし、厳格な CSP を設定しているサイトでは一部機能が制限される可能性があります。</p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">トラブルシューティング</h2>
        <p class="text-sm text-muted-foreground">
          リダイレクトが発生しない場合は、Userscript が有効か、ブラックリストの記述が期待どおりかを確認してください。API 連携を利用している場合はベース URL（ドメインまたは <code>/api</code> まで）とトークンが正しいか、<code>/api/v1/blocks/windows</code> が 200 を返しているかを開発者ツールで確認してください。必要に応じてメニューからキャッシュをクリアし、スクリプトを一時的に無効化してください。</p>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-foreground">接続テスト</h2>
        <p class="text-sm text-muted-foreground">
          下のフォームから TaskWorks API と同じエンドポイントにリクエストを送り、レスポンスの内容やログを確認できます。既定では <code>merge=false</code> と <code>focus_only=false</code> を付与し、タスクごとの時間帯をそのまま表示します。Userscript と同じ条件を再現したい場合はトグルで各パラメータ (<code>focus_only</code> / <code>merge</code> / <code>debug</code>) を切り替えてください。
        </p>
        <UrlBlockApiTester client:load defaultBaseUrl={defaultApiBase || 'https://my-app.yinyoo2904.workers.dev'} defaultFocusOnly={false} />
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold text-foreground">よくある質問（FAQ）</h2>
        <div class="space-y-3 text-sm text-muted-foreground">
          <p><strong class="font-medium text-foreground">Q:</strong> データはどこに保存されますか？<br />
            <strong class="font-medium text-foreground">A:</strong> 設定値は Userscript マネージャの GM.getValue / GM.setValue に保存されます。TaskWorks API 連携を有効にした場合のみ、指定した API へ GET リクエストを送信します。</p>
          <p><strong class="font-medium text-foreground">Q:</strong> ブラックリストの書式は？<br />
            <strong class="font-medium text-foreground">A:</strong> 部分文字列で判定します。必要なら完全一致や正規表現に拡張してください。</p>
          <p><strong class="font-medium text-foreground">Q:</strong> タスクを完了するとどうなりますか？<br />
            <strong class="font-medium text-foreground">A:</strong> 当日の目標回数を満たしたタスクは API レスポンスから除外され、Userscript もブロックを停止します。完了状況は TaskWorks の実行ログ（exec_logs）に基づきます。</p>
          <p><strong class="font-medium text-foreground">Q:</strong> API トークンをどのように扱うべきですか？<br />
            <strong class="font-medium text-foreground">A:</strong> スクリプトはトークンをローカルに保存し、HTTP ヘッダに <code>Authorization: Bearer &lt;token&gt;</code> として付与します。第三者と共有せず、必要に応じて失効・再発行してください。</p>
          <p><strong class="font-medium text-foreground">Q:</strong> 配布したら自動で全員に入りますか？<br />
            <strong class="font-medium text-foreground">A:</strong> いいえ。ユーザ自身で導入する必要があります。</p>
        </div>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">品質管理チェックリスト</h2>
        <ol class="space-y-2 text-sm text-muted-foreground">
          <li>主要ブラウザでインストール・アニメーション・リダイレクト・メニューを確認する。</li>
          <li>TaskWorks API から時間帯を取得できるか、タイムゾーンとフォーカスタグ設定が反映されるかをテストする。</li>
          <li>API 障害時にキャッシュや手動時間帯へフォールバックすることを確認する。</li>
          <li>バージョン番号とリリースノート、配布ページのハッシュを用意する。</li>
          <li>第三者への送信機構を組み込まない。必要な場合は利用者の明示的な同意を得る。</li>
        </ol>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">変更履歴（例）</h2>
        <ul class="space-y-2 text-sm text-muted-foreground">
          <li><span class="font-medium text-foreground">2025-09-19 — v4.1.0:</span> API 応答をタスクごとに保持するよう <code>merge=false</code> と <code>focus_only=false</code> を既定化し、完了済みタスクを自動除外。Userscript は同じパラメータで背景同期を行い、TTL に合わせて自動更新します。</li>
          <li><span class="font-medium text-foreground">2025-09-19 — v4.0.1:</span> API ベース URL の正規化とデフォルトの手動ブロック解除、リダイレクト先の初期値を修正。</li>
          <li><span class="font-medium text-foreground">2025-09-19 — v4.0.0:</span> TaskWorks API 経由でブロック時間帯を自動取得できるよう更新。キャッシュ TTL、フォーカスタグ限定モード、API トークン設定を追加。</li>
          <li><span class="font-medium text-foreground">2025-09-18 — v3.2.0:</span> 猫の手アニメーション挙動を改善。ブラックリスト保存形式を配列に統一。メニュー項目を追加。</li>
        </ul>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">ライセンスと免責</h2>
        <p class="text-sm text-muted-foreground">
          スクリプトはオープンソース（例: MIT）での配布を推奨します。ただし、導入によって発生した不具合や損害については責任を負わない旨を明示し、導入前に機能とリスクを分かりやすく提示してください。
        </p>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold text-foreground">サポート窓口（テンプレ）</h2>
        <p class="text-sm text-muted-foreground">
          問い合わせは公式サポートフォームまたは GitHub Issues で受け付けます。以下の情報を添えてもらうと調査が容易です。
        </p>
        <ul class="space-y-2 text-sm text-muted-foreground">
          <li>利用ブラウザの種類とバージョン</li>
          <li>インストールしたスクリプトのバージョン</li>
          <li>再現手順とスクリーンショット（可能であれば）</li>
        </ul>
      </section>
    </article>

    <p class="text-xs text-muted-foreground">
      配布は容易ですが管理が重要です。導入はユーザ任意とし、ハッシュや配布元の明示など安全対策を徹底してください。
    </p>
  </section>
</Base>
